<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Finance Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 3em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .value.positive {
            color: #10b981;
        }

        .stat-card .value.negative {
            color: #ef4444;
        }

        .stat-card .value.neutral {
            color: #667eea;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .chart-card h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .recent-transactions {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .recent-transactions h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s ease;
        }

        .transaction-item:hover {
            background: #f9fafb;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-merchant {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .transaction-date {
            font-size: 0.85em;
            color: #666;
        }

        .transaction-amount {
            font-size: 1.2em;
            font-weight: bold;
        }

        .transaction-amount.positive {
            color: #10b981;
        }

        .transaction-amount.negative {
            color: #ef4444;
        }

        .nav-links {
            text-align: center;
            margin-top: 30px;
        }

        .nav-links a {
            display: inline-block;
            margin: 0 10px;
            padding: 12px 30px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.5em;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí∞ Finance Dashboard</h1>
            <p>Spr√°va osobn√Ωch financi√≠</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>üìä Celkov√© transakcie</h3>
                <div class="value neutral" id="total-transactions">0</div>
            </div>
            <div class="stat-card">
                <h3>üìâ V√Ωdavky (30 dn√≠)</h3>
                <div class="value negative" id="total-expenses">0 ‚Ç¨</div>
            </div>
            <div class="stat-card">
                <h3>üìà Pr√≠jmy (30 dn√≠)</h3>
                <div class="value positive" id="total-income">0 ‚Ç¨</div>
            </div>
            <div class="stat-card">
                <h3>üí∏ Priemern√Ω v√Ωdavok</h3>
                <div class="value neutral" id="avg-expense">0 ‚Ç¨</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h2>üìä Mesaƒçn√© v√Ωdavky a pr√≠jmy</h2>
                <canvas id="monthlyChart"></canvas>
            </div>
            <div class="chart-card">
                <h2>ü•ß V√Ωdavky podƒæa kateg√≥ri√≠</h2>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <div class="recent-transactions">
            <h2>üîÑ Posledn√© transakcie</h2>
            <div id="transactions-list">
                <div class="loading">Naƒç√≠tavam...</div>
            </div>
        </div>

        <div class="nav-links">
            <a href="/transactions">üìã V≈°etky transakcie</a>
            <a href="/categories">üè∑Ô∏è Kateg√≥rie</a>
            <a href="/settings">‚öôÔ∏è Nastavenia</a>
            <a href="#" onclick="location.reload()">üîÑ Obnovi≈•</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Naƒç√≠tanie ≈°tatist√≠k
        async function loadDashboard() {
            try {
                // Z√°kladn√© ≈°tatistiky - pou≈æijeme spr√°vny endpoint
                const statsResponse = await fetch('/api/summary');
                const statsData = await statsResponse.json();
                
                console.log('Stats data:', statsData);
                
                // ≈†tatistiky - pou≈æijeme spr√°vny form√°t z API
                if (statsData.summary) {
                    const summary = statsData.summary;
                    const totalTransactions = summary.total_transactions || 0;
                    const totalExpenses = summary.total_expenses || 0;
                    const totalIncome = summary.total_income || 0;
                    const avgExpense = summary.avg_expense || 0;
                    
                    document.getElementById('total-transactions').textContent = totalTransactions;
                    document.getElementById('total-expenses').textContent = parseFloat(totalExpenses).toFixed(2) + ' ‚Ç¨';
                    document.getElementById('total-income').textContent = parseFloat(totalIncome).toFixed(2) + ' ‚Ç¨';
                    document.getElementById('avg-expense').textContent = parseFloat(avgExpense).toFixed(2) + ' ‚Ç¨';
                }

                // Posledn√© transakcie
                const txResponse = await fetch('/api/transactions/list?limit=5');
                const txData = await txResponse.json();
                
                if (txData.transactions && txData.transactions.length > 0) {
                    const transactionsList = document.getElementById('transactions-list');
                    transactionsList.innerHTML = '';
                    
                    txData.transactions.forEach(tx => {
                        const extractValue = (obj, ...keys) => {
                            for (let key of keys) {
                                let val = obj[key];
                                if (val && typeof val === 'object' && 'value' in val) {
                                    val = val.value;
                                }
                                if (val !== undefined && val !== null) return val;
                            }
                            return null;
                        };
                        
                        const merchant = extractValue(tx, 'MerchantName', 'merchantname') || 'Nezn√°my';
                        const amount = parseFloat(extractValue(tx, 'Amount', 'amount') || 0);
                        const date = extractValue(tx, 'TransactionDate', 'transactiondate') || '';
                        const category = extractValue(tx, 'CategoryName', 'categoryname') || 'Nezaraden√©';
                        const categoryIcon = extractValue(tx, 'CategoryIcon', 'categoryicon') || 'üì¶';
                        
                        const dateFormatted = date ? new Date(date).toLocaleDateString('sk-SK', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        }) : '';
                        
                        const item = document.createElement('div');
                        item.className = 'transaction-item';
                        item.innerHTML = `
                            <div class="transaction-info">
                                <div class="transaction-merchant">${merchant}</div>
                                <div class="transaction-date">${categoryIcon} ${category} ¬∑ ${dateFormatted}</div>
                            </div>
                            <div class="transaction-amount ${amount < 0 ? 'negative' : 'positive'}">
                                ${amount > 0 ? '+' : ''}${amount.toFixed(2)} ‚Ç¨
                            </div>
                        `;
                        transactionsList.appendChild(item);
                    });
                }

                // Grafy - pou≈æ√≠vame d√°ta z /api/summary
                if (statsData.monthly && statsData.monthly.length > 0) {
                    const months = statsData.monthly.map(m => m.month);
                    const expenses = statsData.monthly.map(m => parseFloat(m.expenses || 0));
                    const income = statsData.monthly.map(m => parseFloat(m.income || 0));
                    
                    createMonthlyChart({ months, expenses, income });
                }
                
                if (statsData.category_pie && statsData.category_pie.length > 0) {
                    createCategoryChart(statsData.category_pie);
                }

            } catch (error) {
                console.error('Chyba pri naƒç√≠tan√≠ d√°t:', error);
            }
        }

        function createMonthlyChart(data) {
            if (!data || !data.months || data.months.length === 0) return;

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'V√Ωdavky',
                        data: data.expenses,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    }, {
                        label: 'Pr√≠jmy',
                        data: data.income,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createCategoryChart(data) {
            if (!data || data.length === 0) return;

            const labels = [];
            const values = [];
            const colors = [];

            data.slice(0, 5).forEach(row => {
                // API vracia: category, amount, icon, color
                // O≈°etrenie pre Turso HTTP API form√°t (m√¥≈æe vr√°ti≈• {type: "null"})
                const icon = (row.icon && typeof row.icon === 'string') ? row.icon : '';
                const color = (row.color && typeof row.color === 'string') ? row.color : '#667eea';
                
                labels.push(icon + (icon ? ' ' : '') + (row.category || 'Nezaraden√©'));
                values.push(Math.abs(parseFloat(row.amount || 0)));
                colors.push(color);
            });

            const ctx = document.getElementById('categoryChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // Naƒç√≠ta≈• dashboard pri naƒç√≠tan√≠ str√°nky
        window.onload = loadDashboard;
    </script>
</body>
</html>

